import os
import requests

NOTION_TOKEN = os.environ["NOTION_TOKEN"]
PAGE_ID = os.environ["NOTION_PAGE_ID"]

NOTION_HEADERS = {
    "Authorization": f"Bearer {NOTION_TOKEN}",
    "Notion-Version": "2022-06-28",
}

def upload_ics():
    # ① アップロード用URLを取得
    url = "https://api.notion.com/v1/files"
    res = requests.post(url, headers=NOTION_HEADERS)
    res.raise_for_status()

    upload_url = res.json()["upload_url"]
    file_id = res.json()["id"]

    # ② ファイルをアップロード
    with open("menu.ics", "rb") as f:
        upload_res = requests.post(upload_url, files={"file": f})
        upload_res.raise_for_status()

    # ③ Notionページにファイルブロックを追加
    block_url = f"https://api.notion.com/v1/blocks/{PAGE_ID}/children"
    block_payload = {
        "children": [
            {
                "object": "block",
                "type": "file",
                "file": {
                    "type": "external",
                    "external": {
                        "url": f"https://api.notion.com/v1/files/{file_id}"
                    }
                }
            }
        ]
    }

    block_res = requests.patch(
        block_url,
        headers={**NOTION_HEADERS, "Content-Type": "application/json"},
        json=block_payload,
    )
    block_res.raise_for_status()

    print("menu.ics uploaded to Notion")

if __name__ == "__main__":
    upload_ics()
